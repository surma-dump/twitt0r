<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<dom-module id="oauth1-ajax">
  <template>
    <iron-ajax
      id="ajax"
      method="[[method]]"
      params="[[params]]"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'oauth1-ajax',
      properties: {
        method: {
          type: String,
          value: 'GET',
          reflectToAttribute: true
        },
        url: {
          type: String,
          reflectToAttribute: true
        },
        consumerKey: {
          type: String,
          reflectToAttribute: true
        },
        consumerSecret: {
          type: String,
          reflectToAttribute: true,
          observer: '_consumerSecretChanged'
        },
        token: {
          type: String,
          value: '',
          observer: '_tokenChanged'
        },
        headers: {
          type: Object,
          value: {}
        },
        params: {
          type: Object,
        },
        oauthVersion: {
          type: String,
          reflectToAttribute: true,
          value: '1.0'
        },
        _signatureMethod: {
          type: String,
          value: 'HMAC-SHA1'
        },
        _cryptoKeyPromiseValid: {
          type: Boolean,
          value: false
        },
        _cryptoKeyPromise: {
          type: Object,
          value: Promise.reject("consumerSecret or token hasnâ€™t been set"),
        }
      },
      _consumerSecretChanged: function() {
        this._cryptoKeyPromiseValid = false;
      },
      _tokenChanged: function() {
        this._cryptoKeyPromiseValid = false;
      },
      _computeCryptoKeyPromise: function() {
        if(this._cryptoKeyPromiseValid) {
          return;
        }
        var signingKey = encodeURIComponent(this.consumerSecret) + '&'
        if(this.token !== '') {
          signingKey += encodeURIComponent(this.token);
        }
        this._cryptoKeyPromise = window.crypto.subtle.importKey(
          'raw',
          new TextEncoder('utf-8').encode(signingKey),
          {
            name: 'HMAC',
            hash: {name: 'SHA-1'}
          },
          false,
          ['sign']
        );
        this._cryptoKeyPromiseValid = true;
      },
      _mapToEncodedArray: function(m) {
        var a = [];
        Object.keys(m).forEach(k => {
          a.push(encodeURIComponent(k) + '=' + encodeURIComponent(m[k]));
        });
        return a;
      },
      generateRequest: function() {
        this._computeCryptoKeyPromise();

        var timestamp = Math.floor(new Date() / 1000);
        // TODO: Use base64([randomBytes]);
        var nonce = btoa('Something random');
        var oauthHeaders = {
          'oauth_consumer_key': this.consumerKey,
          'oauth_nonce': nonce,
          'oauth_timestamp': timestamp,
          'oauth_signature_method': this._signatureMethod,
          'oauth_version': this.oauthVersion
        };
        if(this.token !== '') {
          oauthHeaders['oauth_token'] = this.token;
        }

        var parameters = Object.assign({}, this.params);
        Object.keys(oauthHeaders).forEach(k => {
          parameters[k] = oauthHeaders[k];
        });

        var parameterString = this._mapToEncodedArray(parameters).sort().join('&');
        var signatureBaseString = [
          this.method.toUpperCase(),
          encodeURIComponent(this.url),
          parameterString
        ].join('&');

        this._cryptoKeyPromise.then(key => {
          return window.crypto.subtle.sign(
            'HMAC',
            key,
            new TextEncoder('utf-8').encode(signatureBaseString)
          );
        }).then(binarySignature => {
          oauthHeaders['oauth_signature'] = btoa(binarySignature);
          this.$.ajax.headers = Object.assign(this.headers, {
            'Authorization': 'OAuth ' + this._mapToEncodedArray(oauthHeaders).join(', ')
          });
          this.$.ajax.generateRequest();
        });
      }
    });
  </script>
</dom-module>
